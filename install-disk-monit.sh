#!/bin/bash

# $1 aws_access_key_id
# $2 aws_secret_access_key
# $3 fromEmail
# $4 toEmails sparated by coma (no space). Ex: admin1@domain.com,admin2@domain.com

sudo adduser \
   --system \
   --shell /bin/bash \
   --gecos 'User for managing disk monit' \
   --group \
   --disabled-password \
   --home /home/disk-monit \
   disk-monit

sudo apt-get install awscli -y

AWS_FOLDER=/home/disk-monit/.aws
if [[ ! -d "$AWS_FOLDER" ]]; then
  CREDENTIALS=$AWS_FOLDER/credentials
  CONFIG=$AWS_FOLDER/config
  LOG=/var/log/disk-monit.log
  sudo mkdir $AWS_FOLDER
  echo "[default]" >> $CREDENTIALS
  echo "aws_secret_access_key = $2" >> $CREDENTIALS
  echo "aws_access_key_id = $1" >> $CREDENTIALS
  echo "[default]" >> $CONFIG
  echo "region = eu-west-1" >> $CONFIG
  echo "output = text" >> $CONFIG
  echo "-- BEGIN LOG --" >> $LOG
  sudo chown -R disk-monit:disk-monit $AWS_FOLDER
  sudo chown disk-monit:disk-monit $LOG
fi

CRONTAB=/var/spool/cron/crontabs/disk-monit
if [[ ! -f "$CRONTAB" ]]; then
  echo "* * * * * sh /home/disk-monit/disk-monit.sh  > /var/log/disk-monit.log 2>&1" >> $CRONTAB
  sudo chown -R disk-monit:crontab $CRONTAB
  sudo chmod 600 $CRONTAB
fi

echo IyEvYmluL3NoCgojIHRvRW1haWw9J1sibWljaGFlbC5nb2RlZnJvaWRAb3BlbmdyYXBoeS5jb20iLCJtaWNoYWVsQGdyYXBoeXN0b3JpZXMuY29tIl0nCnRvRW1haWw9J1tAQEBlbWFpbHNAQEBdJwpmcm9tRW1haWw9J0BAQGZyb21FbWFpbEBAQCcKQVdTX0lOU1RBTkNFX0lEPWBjdXJsIC1zIGh0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbGF0ZXN0L21ldGEtZGF0YS9pbnN0YW5jZS1pZGAKRUMyX05BTUU9JChhd3MgZWMyIGRlc2NyaWJlLXRhZ3MgLS1yZWdpb24gZXUtd2VzdC0xIC0tZmlsdGVycyAiTmFtZT1yZXNvdXJjZS1pZCxWYWx1ZXM9JEFXU19JTlNUQU5DRV9JRCIgIk5hbWU9a2V5LFZhbHVlcz1OYW1lIiAtLW91dHB1dCB0ZXh0IHwgY3V0IC1mNSkKI2VjaG8gJEVDMl9OQU1FCmN1cnJlbnRJUD0kKGN1cmwgLXMgaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvbWV0YS1kYXRhL3B1YmxpYy1pcHY0KQoKIyB3aGlsZSB0cnVlOyBkbwpkYXRlPSQoZGF0ZSArIiVzIikKCiNTRVQgREFURSBUTyBMT0cKZW1haWxUaW1lb3V0V3JpdGUgKCkKewogIGlmIFsgISAtZiAiJFBXRC8kMSIgXTsgdGhlbgogICAgdG91Y2ggJFBXRC8kMS50eHQKICBmaQogIHNoIC1jICJlY2hvICRkYXRlID4gJFBXRC8kMS50eHQiCn0KIyBTRU5EIEFNQVpPTiBTRVMKc2VuZEFtYXpvblNlcyAoKQp7CiAgYXdzIHNlcyBzZW5kLWVtYWlsIFwKICAtLWZyb20gJGZyb21FbWFpbCBcCiAgLS1kZXN0aW5hdGlvbiBUb0FkZHJlc3Nlcz0kdG9FbWFpbCBcCiAgLS1tZXNzYWdlICd7ICJTdWJqZWN0IjogeyAiRGF0YSI6ICJbQUxFUlQgU0VSVkVSXSAnIiRFQzJfTkFNRSInIHwgSVA6ICciJGN1cnJlbnRJUCInIHwgJyIkMSInIiwgIkNoYXJzZXQiOiAiVVRGLTgiIH0sICJCb2R5IjogeyAiVGV4dCI6IHsgIkRhdGEiOiAiJyIkMiInIiwgIkNoYXJzZXQiOiAiVVRGLTgiIH0gfSB9Jwp9CiMgZW1haWxUaW1lb3V0V3JpdGUgIm1lc3NhZ2VEaXNrVXNlZF9zZW50IgoKIyBNT05JVE9SIERJU0sgU1BBQ0UKY2hlY2tUeXBlcz0kKGxzYmxrIC1vIEZTVFlQRSkKbWVzc2FnZT0iIgpmb3IgYyBpbiAkY2hlY2tUeXBlczsgZG8KICBpZiBbICIkYyIgPSAiZXh0NCIgXSB8fCBbICIkYyIgPSAieGZzIiBdOyB0aGVuCgogICAgZGlzaz0kKGRmIC10ICRjIHwgYXdrICd7cHJpbnQgJDF9JykKICAgICNlY2hvICRkaXNrCiAgICBjdXJyZW50RGlzaz0kKGVjaG8gJGRpc2sgfCBhd2sgJ3twcmludCAkMn0nKQogICAgIyBlY2hvICRjdXJyZW50RGlzawoKICAgIHBvdXJjZW50YWdlPTkwCiAgICAjIHRvdGFsU3BhY2U9JChkZiB8IGdyZXAgIiRjdXJyZW50RGlzayIgfCBhd2sgJ3twcmludCAkMn0nKQogICAgIyBlY2hvICR0b3RhbFNwYWNlCiAgICAjIG1heFNwYWNlPSQoKCgkdG90YWxTcGFjZSAqICRwb3VyY2VudGFnZSkvMTAwKSkKICAgICMgZWNobyAkdG90YWxTcGFjZQoKICAgICMgdXNlZFNwYWNlPSQoZGYgfCBncmVwICIkY3VycmVudERpc2siIHwgYXdrICd7cHJpbnQgJDR9JykKICAgICMgZWNobyAkdXNlZFNwYWNlCiAgICBwb3VyY2VudFVzZWQ9JChkZiB8IGdyZXAgIiRjdXJyZW50RGlzayIgfCBhd2sgJ3twcmludCAkNX0nKQogICAgcG91cmNlbnRVc2Vkbm9QZXJjZW50PSQoZWNobyAkcG91cmNlbnRVc2VkIHwgc2VkICdzLyUvLycpCgogICAgaWYgWyAkcG91cmNlbnRVc2Vkbm9QZXJjZW50IC1ndCAkcG91cmNlbnRhZ2UgXTsgdGhlbgogICAgICBtZXNzYWdlPSIkbWVzc2FnZSBcbiAkY3VycmVudERpc2sgLSAkcG91cmNlbnRVc2VkIgogICAgICAjIFJFQUQgTE9HIElGIEVYSVNUUwogICAgICBpZiBbIC1mICIkUFdEL21lc3NhZ2VEaXNrVXNlZC50eHQiIF07IHRoZW4KICAgICAgICBtZXNzYWdlRGlza0xhc3RTZW50PSQoY2F0ICRQV0QvbWVzc2FnZURpc2tVc2VkLnR4dCkKICAgICAgICBkaXNrVGltb3V0PSQoKDQgKiAzNjAwKSkKICAgICAgICAjIGRpc2tUaW1vdXQ9JCgoMTIwKSkKICAgICAgICBtZXNzYWdlRGlza05leHRTZW50PSQoKCRtZXNzYWdlRGlza0xhc3RTZW50ICsgJGRpc2tUaW1vdXQpKQogICAgICBmaQogICAgZmkKICBmaQpkb25lCgojIGlmIG1lc3NhZ2Ugbm90IGVtcHR5CmlmIFsgISAteiAiJG1lc3NhZ2UiIF07IHRoZW4KICAjIElGIE5PIExPRyBPUiBEQVRFIEdSRUFURVIgVEhBTiBORVhUIFNFTlQgLT4gU0VORCBNRVNTQUdFIEFORCBFRElUIExPRwogIGlmIFsgISAkbWVzc2FnZURpc2tOZXh0U2VudCBdIHx8IFsgJGRhdGUgLWd0ICRtZXNzYWdlRGlza05leHRTZW50IF07IHRoZW4KICAgICMgZWNobyAnU2VuZCBlbWFpbCBmb3IgRElTSyBFUlJPUicKICAgIHNlbmRBbWF6b25TZXMgIkRpc2sgVXNhZ2Ugb3ZlciA5MCUiICJTZXJ2ZXIgbmFtZTogJEVDMl9OQU1FIFxuIElQOiAkY3VycmVudElQIFxuIEVycm9yOiBEaXNrIHVzYWdlIG92ZXIgOTAlICRtZXNzYWdlIgogICAgZW1haWxUaW1lb3V0V3JpdGUgIm1lc3NhZ2VEaXNrVXNlZCIKICBmaQplbHNlCiAgIyBlY2hvICdEaXNrIE9rJwogICMgRVZFUllUSElORyBPSyAtPiBERUxFVEUgTE9HCiAgaWYgWyAtZiAiJFBXRC9tZXNzYWdlRGlza1VzZWQudHh0IiBdOyB0aGVuCiAgICBybSAkUFdEL21lc3NhZ2VEaXNrVXNlZC50eHQKICBmaQpmaQoKCiMgTU9OSVRPUiBTV0FQCnN3YXBQZXJjZW50PTkwCmNoZWNrU3dhcD0kKHN3YXBvbiAtcykKaWYgWyAhIC16ICIkY2hlY2tTd2FwIiBdOyB0aGVuCiAgc3dhcFVzZWQ9JChmcmVlIC10IHwgYXdrICdOUiA9PSAzIHtwcmludGYoIiUuMmYlIiksICQzLyQyKjEwMH0nKQogIHN3YXBOb1BlcmNlbnQ9JChlY2hvICRzd2FwVXNlZCB8IHNlZCAncy8lLy8nKQogIHJvdW5kZWRTd2FwPSR7c3dhcE5vUGVyY2VudCUuKn0KICAjIGVjaG8gJHJvdW5kZWRTd2FwCiAgaWYgWyAkcm91bmRlZFN3YXAgLWdlICRzd2FwUGVyY2VudCBdOyB0aGVuCiAgICAjIFJFQUQgTE9HIElGIEVYSVNUUwogICAgaWYgWyAtZiAiJFBXRC9tZXNzYWdlU3dhcFVzZWRfc2VudCIgXTsgdGhlbgogICAgICBtZXNzYWdlU3dhcFVzZWRTZW50PSQoY2F0ICRQV0QvbWVzc2FnZVN3YXBVc2VkX3NlbnQpCiAgICAgIHN3YXBUaW1vdXQ9JCgoNCAqIDM2MDApKQogICAgICAjIGRpc2tUaW1vdXQ9JCgoMTIwKSkKICAgICAgbWVzc2FnZVN3YXBOZXh0U2VudD0kKCgkbWVzc2FnZVN3YXBVc2VkU2VudCArICRzd2FwVGltb3V0KSkKICAgICAgIyBlY2hvICRtZXNzYWdlU3dhcE5leHRTZW50CiAgICBmaQogICAgIyBJRiBOTyBMT0cgT1IgREFURSBHUkVBVEVSIFRIQU4gTkVYVCBTRU5UIC0+IFNFTkQgTUVTU0FHRSBBTkQgRURJVCBMT0cKICAgIGlmIFsgISAkbWVzc2FnZVN3YXBOZXh0U2VudCBdIHx8IFsgJGRhdGUgLWd0ICRtZXNzYWdlU3dhcE5leHRTZW50IF07IHRoZW4KICAgICAgIyBlY2hvICdTZW5kIGVtYWlsIGZvciBTd2FwIEVSUk9SJwogICAgICBzZW5kQW1hem9uU2VzICJTd2FwIFVzYWdlIG92ZXIgOTAlIiAiU3dhcCB1c2FnZTogJHN3YXBVc2VkIgogICAgICBlbWFpbFRpbWVvdXRXcml0ZSAibWVzc2FnZVN3YXBVc2VkX3NlbnQiCiAgICBmaQogIGVsc2UKICAgICMgZWNobyAnU3dhcCBPaycKICAgICMgRVZFUllUSElORyBPSyAtPiBERUxFVEUgTE9HCiAgICBpZiBbIC1mICIkUFdEL21lc3NhZ2VTd2FwVXNlZF9zZW50IiBdOyB0aGVuCiAgICAgIHJtICRQV0QvbWVzc2FnZVN3YXBVc2VkX3NlbnQKICAgIGZpCiAgZmkKZmkK | base64 --decode >> /home/disk-monit/disk-monit.sh.model

EMAILS="$4"
#Print the split string
toEmails=$(echo "$EMAILS" | sed -r 's/,/","/g')
toEmails='"'$toEmails'"'
fromEmail="$3"

if [[ -f "/home/disk-monit/disk-monit.sh" ]]; then
  sudo rm /home/disk-monit/disk-monit.sh
fi
sed 's/@@@fromEmail@@@/'$fromEmail'/g' /home/disk-monit/disk-monit.sh.model > /home/disk-monit/disk-monit.sh.model2
sed 's/@@@emails@@@/'$toEmails'/g' /home/disk-monit/disk-monit.sh.model2 > /home/disk-monit/disk-monit.sh
sudo rm /home/disk-monit/disk-monit.sh.model /home/disk-monit/disk-monit.sh.model2 

sudo chmod +x /home/disk-monit/disk-monit.sh
sudo chown -R disk-monit:disk-monit /home/disk-monit/disk-monit.sh
